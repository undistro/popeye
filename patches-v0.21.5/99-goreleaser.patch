From fe5ea377a8c5a50ea5ff58ac858b24fbbf41637e Mon Sep 17 00:00:00 2001
From: Kevin Conner <kev.conner@getupcloud.com>
Date: Thu, 19 Sep 2024 09:46:00 -0700
Subject: [PATCH] Switch to undistro specific goreleaser config


diff --git a/Dockerfile b/Dockerfile
index 9ea717a..db50869 100644
--- a/Dockerfile
+++ b/Dockerfile
@@ -1,27 +1,10 @@
-# -----------------------------------------------------------------------------
-# Build...
-FROM golang:1.23-alpine3.19 AS build
-ARG TARGETOS
-ARG TARGETARCH
-
-WORKDIR /popeye
-
-COPY go.mod go.sum main.go Makefile ./
-COPY internal internal
-COPY cmd cmd
-COPY types types
-COPY pkg pkg
-RUN apk --no-cache add make git gcc libc-dev curl ca-certificates binutils-gold && \
-    CGO_ENABLED=0 GOOS=${TARGETOS:-linux} GOARCH=${TARGETARCH} make build
-
-# -----------------------------------------------------------------------------
-# Image...
 FROM alpine:3.20.3
 
-COPY --from=build /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/ca-certificates.crt
-COPY --from=build /popeye/execs/popeye /bin/popeye
+RUN apk upgrade && rm /var/cache/apk/*
+
+COPY popeye /bin/popeye
 
 RUN adduser -u 5000 -D nonroot
 USER 5000
 
-ENTRYPOINT [ "/bin/popeye" ]
\ No newline at end of file
+ENTRYPOINT [ "/bin/popeye" ]
diff --git a/goreleaser.undistro.yaml b/goreleaser.undistro.yaml
new file mode 100644
index 0000000..c27f179
--- /dev/null
+++ b/goreleaser.undistro.yaml
@@ -0,0 +1,111 @@
+project_name: popeye
+builds:
+  - id: build-linux
+    main: main.go
+    binary: popeye
+    ldflags:
+      - -s -w
+      - "-extldflags '-static'"
+      - "-X github.com/derailed/popeye/cmd.version={{.Version}}"
+      - "-X github.com/derailed/popeye/cmd.commit={{.FullCommit}}"
+      - "-X github.com/derailed/popeye/cmd.date={{.Date}}"
+    env:
+      - CGO_ENABLED=0
+    goos:
+      - linux
+    goarch:
+      - amd64
+      - arm64
+      - s390x
+      - ppc64le
+    goarm:
+      - "7"
+
+dockers:
+  - image_templates:
+      - "ghcr.io/undistro/popeye:{{ .Version }}-amd64"
+    use: buildx
+    goos: linux
+    goarch: amd64
+    ids:
+      - build-linux
+    build_flag_templates:
+      - "--label=org.opencontainers.image.title={{ .ProjectName }}"
+      - "--label=org.opencontainers.image.description=A Kubernetes Live Cluster Linter"
+      - "--label=org.opencontainers.image.version={{ .Version }}"
+      - "--label=org.opencontainers.image.created={{ .Date }}"
+      - "--label=org.opencontainers.image.source=https://github.com/derailed/popeye"
+      - "--label=org.opencontainers.image.revision={{ .FullCommit }}"
+      - "--label=org.opencontainers.image.url=https://github.com/derailed/popeye"
+      - "--platform=linux/amd64"
+  - image_templates:
+      - "ghcr.io/undistro/popeye:{{ .Version }}-arm64"
+    use: buildx
+    goos: linux
+    goarch: arm64
+    ids:
+      - build-linux
+    build_flag_templates:
+      - "--label=org.opencontainers.image.title={{ .ProjectName }}"
+      - "--label=org.opencontainers.image.description=A Kubernetes Live Cluster Linter"
+      - "--label=org.opencontainers.image.version={{ .Version }}"
+      - "--label=org.opencontainers.image.created={{ .Date }}"
+      - "--label=org.opencontainers.image.source=https://github.com/derailed/popeye"
+      - "--label=org.opencontainers.image.revision={{ .FullCommit }}"
+      - "--label=org.opencontainers.image.url=https://github.com/derailed/popeye"
+      - "--platform=linux/arm64"
+  - image_templates:
+      - "ghcr.io/undistro/popeye:{{ .Version }}-s390x"
+    use: buildx
+    goos: linux
+    goarch: s390x
+    ids:
+      - build-linux
+    build_flag_templates:
+      - "--label=org.opencontainers.image.title={{ .ProjectName }}"
+      - "--label=org.opencontainers.image.description=A Kubernetes Live Cluster Linter"
+      - "--label=org.opencontainers.image.version={{ .Version }}"
+      - "--label=org.opencontainers.image.created={{ .Date }}"
+      - "--label=org.opencontainers.image.source=https://github.com/derailed/popeye"
+      - "--label=org.opencontainers.image.revision={{ .FullCommit }}"
+      - "--label=org.opencontainers.image.url=https://github.com/derailed/popeye"
+      - "--platform=linux/s390x"
+  - image_templates:
+      - "ghcr.io/undistro/popeye:{{ .Version }}-ppc64le"
+    use: buildx
+    goos: linux
+    goarch: ppc64le
+    ids:
+      - build-linux
+    build_flag_templates:
+      - "--label=org.opencontainers.image.title={{ .ProjectName }}"
+      - "--label=org.opencontainers.image.description=A Kubernetes Live Cluster Linter"
+      - "--label=org.opencontainers.image.version={{ .Version }}"
+      - "--label=org.opencontainers.image.created={{ .Date }}"
+      - "--label=org.opencontainers.image.source=https://github.com/derailed/popeye"
+      - "--label=org.opencontainers.image.revision={{ .FullCommit }}"
+      - "--label=org.opencontainers.image.url=https://github.com/derailed/popeye"
+      - "--platform=linux/ppc64le"
+
+docker_manifests:
+  - name_template: 'ghcr.io/undistro/popeye:{{ .Version }}'
+    image_templates:
+    - 'ghcr.io/undistro/popeye:{{ .Version }}-amd64'
+    - 'ghcr.io/undistro/popeye:{{ .Version }}-arm64'
+    - 'ghcr.io/undistro/popeye:{{ .Version }}-s390x'
+    - 'ghcr.io/undistro/popeye:{{ .Version }}-ppc64le'
+  - name_template: 'ghcr.io/undistro/popeye:{{ .Major }}.{{ .Minor }}'
+    image_templates:
+    - 'ghcr.io/undistro/popeye:{{ .Version }}-amd64'
+    - 'ghcr.io/undistro/popeye:{{ .Version }}-arm64'
+    - 'ghcr.io/undistro/popeye:{{ .Version }}-s390x'
+    - 'ghcr.io/undistro/popeye:{{ .Version }}-ppc64le'
+  - name_template: 'ghcr.io/undistro/popeye:latest'
+    image_templates:
+    - 'ghcr.io/undistro/popeye:{{ .Version }}-amd64'
+    - 'ghcr.io/undistro/popeye:{{ .Version }}-arm64'
+    - 'ghcr.io/undistro/popeye:{{ .Version }}-s390x'
+    - 'ghcr.io/undistro/popeye:{{ .Version }}-ppc64le'
+
+release:
+  disable: true
